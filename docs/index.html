<!-- HTML header for doxygen 1.8.20-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dual Active Bridge Development Board: Dual Active Bridge Development Board</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mchp.css" rel="stylesheet" type="text/css"/>
<link href="mchp_theme.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="border:0px; border-spacing: 0px; border-collapse: collapse; vertical-align: middle; width: 100%;">
    <tbody>
        <tr style="border: none; background-color: #00000000;">
            <!--SITE HEADER-->
            <td style="width: 120px; border: none;">
                <img alt="Bar" height="60px" src="images/mchp-brandingelement-rgb2.png"/>
            </td>
            <td style="width: 220px; border: none;">
                <img alt="Logo" height=50px src="images/microchip.png"/>
            </td>
            <td colspan="4" style="font-size: 16pt; font-weight: bolder;">
                Dual Active Bridge Development Board (Part-No. ) 
            </td>
            <td style="text-align: right; vertical-align: middle;">
                        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
            </td>
            <!--END SITE HEADER-->
        </tr>
        <tr style="height:36px; border:none; background-color: #000000b0;">
            <td style="width: 70px; color: white; font-size:14px; font-weight: bolder; margin-left: 30px;">
                <div style="margin-left: 30px;">Content</div>
            </td>
            <td style="width: 10px; color: white; font-size:14px; font-weight: bolder;">
                &nbsp;
            </td>
            <td style="width: 100px; color: white; font-size:14px; font-weight: bolder;">
                <!-- Overview -->
            </td>
            <td style="width: 130px; color: white; font-size:14px; font-weight: bolder;"> 
                <!-- Documentation -->
            </td>
            <td style="width: 170px; color: white; font-size:14px; font-weight: bolder;"> 
                <!-- Additional Resources -->
            </td>
            <td style="width: auto; color: white; font-size:14px; font-weight: bolder;"> 
              &nbsp;
            </td>
            <td style="width: 310px; margin-right: 30px; color: white; font-size:10px; font-weight: lighter; text-align: right;">
                &nbsp;
            </td>
        </tr>
    </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Dual Active Bridge Development Board </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a> <img src="images/microchip.png" alt="image" class="inline"/></p>
<hr  />
 <h1><a class="anchor" id="autotoc_md1"></a>
dsPIC33CK Power DC-DC Dual Active Bridge Development Platform</h1>
<center> </center><center> <img src="images/DAB-board-front.jpg" alt="dsPIC33C DAB Development Board" width="400" class="inline"/> &#160; <img src="images/DAB-board-back.jpg" alt="" width="400" class="inline"/></center><center>  </center> <center>  dsPIC33C DAB Development Board  </center> <p><span id="start-doc"><a class="anchor" id="start-doc"></a></span></p>
<hr  />
<p> <span id="summary"><a class="anchor" id="summary"></a> </span></p>
<h2><a class="anchor" id="autotoc_md3"></a>
Summary</h2>
<p>This solution demonstrates the implementation of a Dual Active Bridge (DAB) Application Demonstration based on Microchip's dsPIC33C device with its primary target application as an automotive On-Board Charger.</p>
<p>The DC-DC Dual Active Bridge Development Platform is a generic development board with well organized building blocks that include an input filter, power stage, auxiliary supply, mating socket for Microchip's newest Digital Power Plug-In Modules (DP PIMs), Human Machine Interface (HMI) and test points. The electrical characteristics are prepared to allow safe voltage levels of up to 700 VDC primary voltage and up to 400 VDC secondary voltage. A mating socket for dsPIC33 plug-in modules allows the system to be evaluated with different controllers. The pinout is compatible for EP, CK and CH dsPIC® DSC DP PIMs. A Human-Machine-Interface (HMI) and test points allow for easy evaluation and debugging.</p>
<p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<hr  />
<p><span id="highlights"><a class="anchor" id="highlights"></a> </span></p>
<h2><a class="anchor" id="autotoc_md5"></a>
Highlights</h2>
<ul>
<li>Digitally-Controlled Dual Active Bridge Converter</li>
<li>Utilization of dsPIC peripherals that allows switching frequency operation ranging from 65KHz to 300KHz</li>
<li>dspic33 plug-in module mating socket pinout compatible to other DSC DP PIMs.</li>
</ul>
<p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<hr  />
<h2><a class="anchor" id="autotoc_md7"></a>
Related Documentation</h2>
<p><b>Firmware documentation</b></p>
<ul>
<li>[Online Firmware Documentation of this Code Example]()</li>
</ul>
<p><b>Hardware Documentation</b></p>
<ul>
<li>ADD HERE HARDWARE DOCUMENTATION</li>
</ul>
<p><b>Target Device Documentation</b></p>
<ul>
<li><a href="https://www.microchip.com/70005349">dsPIC33CK256MP508 Family Data Sheet</a></li>
<li><a href="https://www.microchip.com/80000796">dsPIC33CK256MP508 Family Silicon Errata and Data Sheet Clarification</a></li>
</ul>
<p><b>Please always check for the latest data sheets on the respective product websites:</b></p>
<ul>
<li><a href="https://www.microchip.com/dsPIC33CK256MP508">dsPIC33CK256MP508 Family</a></li>
<li><p class="startli"><a href="https://www.microchip.com/dsPIC33CH512MP508">dsPIC33CH512MP508 Family</a></p>
<p class="startli">[<a class="el" href="index.html#start-doc">back to top</a>]</p>
</li>
</ul>
<hr  />
<p><span id="software-tools-used"><a class="anchor" id="software-tools-used"></a> </span></p>
<h2><a class="anchor" id="autotoc_md9"></a>
Software Used</h2>
<ul>
<li><a href="https://www.microchip.com/en-us/software-library/power_board_visualizer">Power Board Visualizer GUI</a></li>
<li><a href="https://www.microchip.com/mplabx-ide-windows-installer">MPLAB&reg; X IDE v6.20</a></li>
<li><a href="https://www.microchip.com/mplabxc16windows">MPLAB&reg; XC-DSC Compiler v3.10</a></li>
<li><a href="https://www.microchip.com/mplab/mplab-code-configurator">Microchip Code Configurator v5.5.1</a></li>
<li><a href="https://www.microchip.com/developmenttools/ProductDetails/DCDT">Digital Compensator Design Tool</a></li>
</ul>
<p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<hr  />
<p><span id="hardware-used"><a class="anchor" id="hardware-used"></a> </span></p>
<h2><a class="anchor" id="autotoc_md11"></a>
Hardware Used</h2>
<ul>
<li>[dsPIC33C DAB Development Board]()</li>
</ul>
<p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<hr  />
<h2><a class="anchor" id="autotoc_md13"></a>
Firmware Overview</h2>
<p>An overview of the firmware is shown below. The power controller state machine and fault handler are executed every 100us by the scheduler. So also are the GUI handler (every 10ms), and the LED and Fan execution and temperature checking (every 100ms).</p>
<p>There is one interrupt source.</p>
<ul>
<li><b>ControlLoop_Interrupt_CallBack</b>: executed every 10us. Voltages and currents in teh DAB board is being measured by ADC and feed to the control loops. There are three control loops in this implementation where Voltage loop and Power loop are executed every 10KHz, interleaved, while Current Loop is executed every 100KHz. </li>
</ul>
<center> <img src="images/tasks-diagram.png" alt="firmware-0" width="800" class="inline"/> <br  />
 Firmware overview. </center> <p>Microchip Code Configurator (MCC) is used to configure the peripherals. They are configured at run-time at the start of <em>main()</em> function, before the background loop is initiated.</p>
<p>The task files are as follows:</p><ul>
<li><em><a class="el" href="a00284_source.html">app/app_PBV_CAN.c</a></em> : Contains the objects and functions for CAN communication.</li>
<li><em><a class="el" href="a00290_source.html">app/app_PBV_config.c</a></em> : Configures the list of functions that needs to be executed when Power Board Visualizer (PBV) use CAN communication or Uart communication.</li>
<li><em><a class="el" href="a00296_source.html">app/app_PBV_dab_frame_map.c</a></em> : User configuration for data that will be transmitted and received to/from Power Board Visualizer.</li>
<li><em><a class="el" href="a00302_source.html">app/app_PBV_interface.c</a></em> : Contains generic communicationfunctions for Power board Visualizer.</li>
<li><em><a class="el" href="a00308_source.html">app/app_PBV_UART.c</a></em> : Contains the objects and functions for CAN communication.</li>
<li><em><a class="el" href="a00332_source.html">device/dev_current_sensor.c</a></em> : Contains function that measures the current sensor offset.</li>
<li><em><a class="el" href="a00338_source.html">device/dev_fan.c</a></em> : Contains functions that initialize and changes the speed of the fan.</li>
<li><em><a class="el" href="a00350_source.html">device/dev_led.c</a></em> : Contains LED functions that gives the user an indication of the current state of the power converter.</li>
<li><em><a class="el" href="a00356_source.html">device/dev_temp.c</a></em> : Contains the temperature indication and calculation for the actual board temperature.</li>
<li><em><a class="el" href="a00362_source.html">fault/dev_fault.c</a></em> : Contains the fault initialization, execution and fault handling.</li>
<li><em><a class="el" href="a00374_source.html">fault/dev_fault_common.c</a></em> : Contains generic fault functions for handling fault events.</li>
<li><em><a class="el" href="a00410_source.html">pwrctrl/dev_pwrctrl.c</a></em> : Contains power control initialization including control loop initialization and start-up initialization, and the power control execution.</li>
<li><em><a class="el" href="a00422_source.html">pwrctrl/dev_pwrctrl_isr.c</a></em> : Contains Control loop interrupt Callback that acquires the ADC raw data and process it in the control loop, and use the control output for the PWM distribution for this converter</li>
<li><em><a class="el" href="a00428_source.html">pwrctrl/dev_pwrctrl_pwm.c</a></em> : Contains DAB control phase calculation between primary and secondary, and the PWM distribution.</li>
<li><em><a class="el" href="a00434_source.html">pwrctrl/dev_pwrctrl_sm.c</a></em> : Contains power control state machine that is executed every 100us.</li>
<li><em><a class="el" href="a00440_source.html">pwrctrl/dev_pwrctrl_utils.c</a></em> : Contains generic functions that handles power control ramp Up/Down and, the averaging generic fucntion.</li>
</ul>
<center> <img src="images/dab-block-diagram.jpg" alt="firmware-0" width="850" class="inline"/> <br  />
 Firmware block diagram. </center> <p>This firmware block diagram depicts how the dspic33C was used for Dual Active bridge converter. Below is the detailed information how the firmware was built for this application.</p>
<p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<hr  />
<p><span id="converter-state-machine"><a class="anchor" id="converter-state-machine"></a> </span></p>
<h2><a class="anchor" id="autotoc_md14"></a>
Converter State Machine</h2>
<p>The main power controller state machine is illustrated below. It is executed every 100us. The code is located in <em><a class="el" href="a00434_source.html">pwrctrl/dev_pwrctrl_sm.c</a></em>, see the function <a class="el" href="a00521.html#gaebef55c78d9df043c293ffcf8a06b63f" title="Manages the power control state machine.">Dev_PwrCtrl_StateMachine(POWER_CONTROL_t* pcInstance)</a>. During execution, the state machine goes through the following steps in chronological order.</p>
<h3>Operating States</h3>
<ul>
<li><em><a class="el" href="a00521.html#ga8307344d190a5459682d315fc7bfe198" title="Executes function for initialze state machine.">PCS_INIT_handler()</a></em> : This state resets the conditional flag bits, ensures PWM output is disabled and run the initial current calibration offset. After this, the state machine moves to checking the fault handler.</li>
<li><em><a class="el" href="a00521.html#gaad6ef2378120876a621b349c1380aef7" title="Executes the fault handler state machine.">PCS_WAIT_IF_FAULT_ACTIVE_handler()</a></em> : This state checks if there is fault event that occurred. When there is no fault event, the state machine moves to StandBy state.</li>
<li><em><a class="el" href="a00521.html#ga42f7c8f65745b2f81bb6dbd381ea8121" title="Executes Standby State machine.">PCS_STANDBY_handler()</a></em> : This state waits until there is no fault event that has occurred and when the power control enable bit is set. When Enable bit is set, then this state reset the fault objects status bits, reset PWM control settings, enable the power control running bit, enable PWM physical output, initialize control loop references and then move to the soft start state.</li>
<li><em><a class="el" href="a00521.html#gabda6b853bb6547821acd0ec87e0a4842" title="Executes the power control soft start state machine.">PCS_SOFT_START_handler()</a></em> : This state gradually ramps up/down the references of the power control. The control loop references are gradually incremented/decremented until in reached the desired control reference. When this is achieved, the next state will be assigned to state online.</li>
<li><em><a class="el" href="a00521.html#ga8752fbb48416e60141e205f1cbda0f98" title="Executes the Online state.">PCS_UP_AND_RUNNING_handler()</a></em> : Once the start procedure has been completed successfully, the converter state machine drops into constant regulation mode, where it will remain until the converter is shut-down or suspended. During constant regulation the control reference is monitored. If the value of the control reference is changed, the state machine will tune into the new reference by generating a defined transition ramp using the ramp slope specified in the startup ramp timing.</li>
</ul>
<center> <img src="images/dab-state-machine.jpg" alt="state-machine" width="450" class="inline"/> <br  />
 Power supply state machine. </center> <p><span id="soft-starting-the-converter"><a class="anchor" id="soft-starting-the-converter"></a> </span></p>
<h2><a class="anchor" id="autotoc_md15"></a>
Power Control Data Structure</h2>
<p>Before the state machine can be used, at least one Power control data object has to be defined and initialized in the power control code.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="a00732.html">POWER_CONTROL_s</a></div>
<div class="line">{</div>
<div class="line">    <a class="code hl_struct" href="a00708.html">STATUS_FLAGS_t</a>          <a class="code hl_variable" href="a00732.html#ae5b4ae59c620ed360f0cb1c66ea0cd4e">Status</a>; </div>
<div class="line">    PWR_CTRL_STATE_t        <a class="code hl_variable" href="a00732.html#a8b22029ea33e1bafe7050317294309c2">State</a>;  </div>
<div class="line">    <a class="code hl_struct" href="a00728.html">PWR_CTRL_PROPERTIES_t</a>   <a class="code hl_variable" href="a00732.html#a2c015371f9d53a7ba0131e65634f8129">Properties</a>; </div>
<div class="line">    <a class="code hl_struct" href="a00700.html">SWITCH_NODE_t</a>           <a class="code hl_variable" href="a00732.html#a133fe9da595a11547aacc8e4f1ae3b8a">Pwm</a>;    </div>
<div class="line">    <a class="code hl_struct" href="a00704.html">FEEDBACK_SETTINGS_t</a>     <a class="code hl_variable" href="a00732.html#a9961eac6798b52736528d9d4aa30d922">Data</a>;   </div>
<div class="line">    <a class="code hl_struct" href="a00676.html">FAULT_SETTINGS_t</a>        <a class="code hl_variable" href="a00732.html#aead2ae6cfabf4831af21d23684e19d1f">Fault</a>;  </div>
<div class="line">    <a class="code hl_struct" href="a00720.html">START_UP_RAMP_t</a>         <a class="code hl_variable" href="a00732.html#afd1d9d28f344713441a2330e010de959">VRamp</a>;  </div>
<div class="line">    <a class="code hl_struct" href="a00720.html">START_UP_RAMP_t</a>         <a class="code hl_variable" href="a00732.html#afdaae86371984281bf846fac8b1d918a">IRamp</a>;  </div>
<div class="line">    <a class="code hl_struct" href="a00720.html">START_UP_RAMP_t</a>         <a class="code hl_variable" href="a00732.html#a7969f4ded01738878ec44b5a56985c85">PRamp</a>;  </div>
<div class="line">    <a class="code hl_struct" href="a00724.html">CONTROLLER_t</a>            <a class="code hl_variable" href="a00732.html#a13383149438802e4c6c08683d6d004db">ILoop</a>;  </div>
<div class="line">    <a class="code hl_struct" href="a00724.html">CONTROLLER_t</a>            <a class="code hl_variable" href="a00732.html#a74800143138c6a887f2edec0e47008a8">VLoop</a>;  </div>
<div class="line">    <a class="code hl_struct" href="a00724.html">CONTROLLER_t</a>            <a class="code hl_variable" href="a00732.html#a14f61bb42ecc88a3ff43a417b48194b0">PLoop</a>;  </div>
<div class="line">    PWR_CTRL_CHARGE_STATE_t    <a class="code hl_variable" href="a00732.html#aab4ae5a26b108cbc7a8c541c3b82ed2f">PowerDirection</a>;  </div>
<div class="line">};</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="a00732.html">POWER_CONTROL_s</a> <a class="code hl_struct" href="a00732.html">POWER_CONTROL_t</a>;</div>
<div class="ttc" id="aa00676_html"><div class="ttname"><a href="a00676.html">FAULT_SETTINGS_s</a></div><div class="ttdef"><b>Definition</b> <a href="a00380_source.html#l00037">dev_fault_typedef.h:38</a></div></div>
<div class="ttc" id="aa00700_html"><div class="ttname"><a href="a00700.html">SWITCH_NODE_s</a></div><div class="ttdoc">Power converter switch-node specifications.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00051">dev_pwrctrl_typedef.h:52</a></div></div>
<div class="ttc" id="aa00704_html"><div class="ttname"><a href="a00704.html">FEEDBACK_SETTINGS_s</a></div><div class="ttdoc">Publicly accessible data buffer of most recent runtime data values.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00074">dev_pwrctrl_typedef.h:75</a></div></div>
<div class="ttc" id="aa00708_html"><div class="ttname"><a href="a00708.html">STATUS_FLAGS_s</a></div><div class="ttdoc">Power converter status flags.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00096">dev_pwrctrl_typedef.h:96</a></div></div>
<div class="ttc" id="aa00720_html"><div class="ttname"><a href="a00720.html">START_UP_RAMP_s</a></div><div class="ttdoc">stores data related to controller</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00116">dev_pwrctrl_typedef.h:117</a></div></div>
<div class="ttc" id="aa00724_html"><div class="ttname"><a href="a00724.html">CONTROLLER_s</a></div><div class="ttdoc">stores data related to controller</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00140">dev_pwrctrl_typedef.h:141</a></div></div>
<div class="ttc" id="aa00728_html"><div class="ttname"><a href="a00728.html">PWR_CTRL_PROPERTIES_s</a></div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00163">dev_pwrctrl_typedef.h:164</a></div></div>
<div class="ttc" id="aa00732_html"><div class="ttname"><a href="a00732.html">POWER_CONTROL_s</a></div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00176">dev_pwrctrl_typedef.h:177</a></div></div>
<div class="ttc" id="aa00732_html_a13383149438802e4c6c08683d6d004db"><div class="ttname"><a href="a00732.html#a13383149438802e4c6c08683d6d004db">POWER_CONTROL_s::ILoop</a></div><div class="ttdeci">CONTROLLER_t ILoop</div><div class="ttdoc">structure for current controller data</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00187">dev_pwrctrl_typedef.h:187</a></div></div>
<div class="ttc" id="aa00732_html_a133fe9da595a11547aacc8e4f1ae3b8a"><div class="ttname"><a href="a00732.html#a133fe9da595a11547aacc8e4f1ae3b8a">POWER_CONTROL_s::Pwm</a></div><div class="ttdeci">SWITCH_NODE_t Pwm</div><div class="ttdoc">Switch node settings.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00181">dev_pwrctrl_typedef.h:181</a></div></div>
<div class="ttc" id="aa00732_html_a14f61bb42ecc88a3ff43a417b48194b0"><div class="ttname"><a href="a00732.html#a14f61bb42ecc88a3ff43a417b48194b0">POWER_CONTROL_s::PLoop</a></div><div class="ttdeci">CONTROLLER_t PLoop</div><div class="ttdoc">structure for power controller data</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00189">dev_pwrctrl_typedef.h:189</a></div></div>
<div class="ttc" id="aa00732_html_a2c015371f9d53a7ba0131e65634f8129"><div class="ttname"><a href="a00732.html#a2c015371f9d53a7ba0131e65634f8129">POWER_CONTROL_s::Properties</a></div><div class="ttdeci">PWR_CTRL_PROPERTIES_t Properties</div><div class="ttdoc">Power Control properties</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00180">dev_pwrctrl_typedef.h:180</a></div></div>
<div class="ttc" id="aa00732_html_a74800143138c6a887f2edec0e47008a8"><div class="ttname"><a href="a00732.html#a74800143138c6a887f2edec0e47008a8">POWER_CONTROL_s::VLoop</a></div><div class="ttdeci">CONTROLLER_t VLoop</div><div class="ttdoc">structure for voltage controller data</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00188">dev_pwrctrl_typedef.h:188</a></div></div>
<div class="ttc" id="aa00732_html_a7969f4ded01738878ec44b5a56985c85"><div class="ttname"><a href="a00732.html#a7969f4ded01738878ec44b5a56985c85">POWER_CONTROL_s::PRamp</a></div><div class="ttdeci">START_UP_RAMP_t PRamp</div><div class="ttdoc">Power ramp-up settings.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00186">dev_pwrctrl_typedef.h:186</a></div></div>
<div class="ttc" id="aa00732_html_a8b22029ea33e1bafe7050317294309c2"><div class="ttname"><a href="a00732.html#a8b22029ea33e1bafe7050317294309c2">POWER_CONTROL_s::State</a></div><div class="ttdeci">PWR_CTRL_STATE_t State</div><div class="ttdoc">Power Control State ID.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00179">dev_pwrctrl_typedef.h:179</a></div></div>
<div class="ttc" id="aa00732_html_a9961eac6798b52736528d9d4aa30d922"><div class="ttname"><a href="a00732.html#a9961eac6798b52736528d9d4aa30d922">POWER_CONTROL_s::Data</a></div><div class="ttdeci">FEEDBACK_SETTINGS_t Data</div><div class="ttdoc">Feedback channel settings.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00182">dev_pwrctrl_typedef.h:182</a></div></div>
<div class="ttc" id="aa00732_html_aab4ae5a26b108cbc7a8c541c3b82ed2f"><div class="ttname"><a href="a00732.html#aab4ae5a26b108cbc7a8c541c3b82ed2f">POWER_CONTROL_s::PowerDirection</a></div><div class="ttdeci">PWR_CTRL_CHARGE_STATE_t PowerDirection</div><div class="ttdoc">defines if the power converter is in charging or discharging mode</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00190">dev_pwrctrl_typedef.h:190</a></div></div>
<div class="ttc" id="aa00732_html_ae5b4ae59c620ed360f0cb1c66ea0cd4e"><div class="ttname"><a href="a00732.html#ae5b4ae59c620ed360f0cb1c66ea0cd4e">POWER_CONTROL_s::Status</a></div><div class="ttdeci">STATUS_FLAGS_t Status</div><div class="ttdoc">Power Supply status flags.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00178">dev_pwrctrl_typedef.h:178</a></div></div>
<div class="ttc" id="aa00732_html_aead2ae6cfabf4831af21d23684e19d1f"><div class="ttname"><a href="a00732.html#aead2ae6cfabf4831af21d23684e19d1f">POWER_CONTROL_s::Fault</a></div><div class="ttdeci">FAULT_SETTINGS_t Fault</div><div class="ttdoc">Fault flags and settings.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00183">dev_pwrctrl_typedef.h:183</a></div></div>
<div class="ttc" id="aa00732_html_afd1d9d28f344713441a2330e010de959"><div class="ttname"><a href="a00732.html#afd1d9d28f344713441a2330e010de959">POWER_CONTROL_s::VRamp</a></div><div class="ttdeci">START_UP_RAMP_t VRamp</div><div class="ttdoc">Voltage ramp-up settings.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00184">dev_pwrctrl_typedef.h:184</a></div></div>
<div class="ttc" id="aa00732_html_afdaae86371984281bf846fac8b1d918a"><div class="ttname"><a href="a00732.html#afdaae86371984281bf846fac8b1d918a">POWER_CONTROL_s::IRamp</a></div><div class="ttdeci">START_UP_RAMP_t IRamp</div><div class="ttdoc">Current ramp-up settings.</div><div class="ttdef"><b>Definition</b> <a href="a00437_source.html#l00185">dev_pwrctrl_typedef.h:185</a></div></div>
</div><!-- fragment --><h5>Declaration Examples</h5>
<div class="fragment"><div class="line"><a class="code hl_struct" href="a00732.html">POWER_CONTROL_t</a> <a class="code hl_variable" href="a00524.html#ga5762de26b3d1b822c6a4b9c1605cd387">dab</a>;    <span class="comment">// Declare DAB converter data structure</span></div>
<div class="ttc" id="aa00524_html_ga5762de26b3d1b822c6a4b9c1605cd387"><div class="ttname"><a href="a00524.html#ga5762de26b3d1b822c6a4b9c1605cd387">dab</a></div><div class="ttdeci">POWER_CONTROL_t dab</div><div class="ttdoc">Global data object for a DAB Converter.</div><div class="ttdef"><b>Definition</b> <a href="a00410_source.html#l00038">dev_pwrctrl.c:38</a></div></div>
</div><!-- fragment --><p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<hr  />
<p><span id="fault-protection"><a class="anchor" id="fault-protection"></a> </span></p>
<h2><a class="anchor" id="autotoc_md16"></a>
Fault Protection</h2>
<p>The fault protection code is executed every 10us in theinterrupt service routine in the function <em>Dev_Fault_Execute()</em>. The body of the fault code is located in the files <em><a class="el" href="a00362_source.html">device/fault/dev_fault.c</a></em>.</p>
<p>There are two types of protection:</p>
<ol type="1">
<li>Firmware fault protection</li>
<li>Hardware fault protection</li>
</ol>
<p>The firmware fault protection is implemented on the dsPIC on the DP-PIM. The hardware fault protection is implemented on the DAB power board. It's purpose is to prevent catastrophic board damage, particularly due to input and output over current events.</p>
<p>[<a class="el" href="index.html#start-doc">back to top</a>] </p><hr  />
<p><span id="firmware-fault-protection"><a class="anchor" id="firmware-fault-protection"></a> </span></p>
<h3>Firmware Fault Protection</h3>
<p>All of our firmware fault protection has the same functionality. Each fault has a trigger threshold, a clear threshold, a fault blanking time and a fault clear time.</p>
<p>This is illustrated below, for a fault with a "max" threshold, which means that the fault is triggered when the fault source is above a threshold (output over voltage protection, for example).</p>
<p>Once the fault source breaches the trigger threshold, a timer is started. If the fault source stays above the trigger threshold for longer than the fault blanking time, then the fault becomes active, which means that the PWMs are switched off and the converter state machine is set to the "FAULT ACTIVE" state.</p>
<p>If the fault source drops back below the trigger threshold before the fault blanking time has expired, the timer is reset. <br  />
</p>
<p>When the fault is active, if the fault source stays below the fault clear threshold for the duration of the fault clear time, then the fault is cleared. When all fault sources are cleared, the converter will attempt to restart.</p>
<center> <img src="images/fault.png" alt="fault-protection" width="800" class="inline"/> <br  />
 Firmware Fault protection. </center> <p>This is shown in more detail in a flowchart below. When "fault active == true", then the fault is active and the converter is disabled. When "fault active == false" the converter can attempt to start up.</p>
<center> <img src="images/fault-diagram.png" alt="fault-protection" width="750" class="inline"/> <br  />
 Flowchart illustrating the firmware fault protection. </center> <p>All faults shown in the table below have firmware protection like this. In our firmware, this fault protection is run every 10us.</p>
<center> <img src="images/dab-fault-threshold.jpg" alt="fault-protection" width="700" class="inline"/> <br  />
 DAB faults with firmware protection. </center> <p>[<a class="el" href="index.html#start-doc">back to top</a>] </p><hr  />
<p><span id="hardware-fault-protection"><a class="anchor" id="hardware-fault-protection"></a> </span></p>
<h3>Hardware fault protection</h3>
<p>The purpose of the hardware fault protection is to prevent catastrophic board damage, particularly from input or output over current. Once triggered, it kicks in immediately (there is no fault blanking time). It sets all PWM drive signals to 0, which will turn off the converter. Note that this is completely independent of the dsPIC, so even if there are drive signals coming from the dsPIC when the hardware fault protection is tripped, the hardware protection will over-ride these signals (through AND gates on the hardware) before they get to the FET drivers.</p>
<center> <img src="images/" alt="fault-protection" width="400" class="inline"/> <br  />
 DAB faults with hardware protection. </center> <p>If the hardware fault protection is triggered, the red LED will turn on. The protection is latched, meaning that once triggered it will not clear itself, it needs to be manually cleared.</p>
<p>If you want to re-run the board, you need to</p>
<ul>
<li>disable all PWMs first, either by holding down the RESET push button, or erasing the dsPIC firmware (we recommend the second option as it is safer)</li>
<li>then short press the "RESET protection" push button on the HMI interface.</li>
</ul>
<p>On the dsPIC, output over current protection using comparators and DACs is also implemented as follows:</p>
<ul>
<li>Current transformer in high voltage Bridge sense tied to CMP1DAC</li>
<li>Current transformer in low voltage Bridge sense tied to CMP3DAC</li>
</ul>
<p>Either of these comparators tripping will trigger the highest priority interrupt, which disables all PWM drive signals and puts the converter in the "FAULT ACTIVE" state. Like the hardware fault protection, this fault protection is also latched, meaning that the dsPIC needs to be reset to restart the converter. If this fault protection is triggered, the RESET flag in the Power Board Visualizer GUI will be set, as shown below, indicating that the dsPIC needs to be reset to re-start the LLC converter.</p>
<center> <img src="images/" alt="fault-protection" width="250" class="inline"/> <br  />
 DAB faults with hardware protection. </center> <p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<hr  />
<p><span id="pwm-setup"><a class="anchor" id="pwm-setup"></a> </span></p>
<h2><a class="anchor" id="autotoc_md17"></a>
PWM Setup</h2>
<p>Most of the PWM setup is done by calling initialization functions generated by MCC at the top of <em>main()</em>. Some more custom configuration is also done at runtime as required. PWM scheme used for this DAB application is dual phase shift (DPS) modulation. DPS PWM scheme change the phase not only the primary to secondary phase but, also the phases in primary bridges, and secondary bridges. This gives an advantage over the traditional phase shift (TPS) control in terms of current stress and improved system efficiency.</p>
<center> <img src="images/digital-pwm-signal.jpg" alt="PWM signal" width="800" class="inline"/></center><center> DAB Dual phase shift control </center> <hr  />
<p><span id="pwm-routing"><a class="anchor" id="pwm-routing"></a> </span></p>
<h3>PWM Routing</h3>
<p>In this application, the DAB's primary bridge is drive by PWM1 (for P1 and P2) and PWM3 (for P3 and P4) while the secondary bridge where drive by PWM2 (for S1 and S2) and PWM4 (for S3 and S4). Each PWMs run in complementary mode, with PWM2 and PWM4 with swapped output.</p>
<center> <img src="images/dab-schematic.jpg" alt="" width="800" class="inline"/></center><center> Simplified DAB schematic </center> <center> <img src="images/pwm-soc.jpg" alt="" width="800" class="inline"/></center><center> Cascaded PWM modules </center> <p>PWMs are also configured in a cascaded way where the first PWM triggers the next PWM successively. This approach broadcasts a single PWM update to all PWMs, thus ensuring that the PWMs are updated in the same cycle. In the DAB application, PWM1 is a master PWM while PWM2, PWM3, and PWM4 are the secondary PWMs that follows PWM1. The figure below depicts the PWM configuration when the Start of Cycle of PWM2/3/4 are dependent to the PWM prior to its instance (PWM2 start of cycle is PWM1, PWM3 start of cycle is PWM2, and PWM4 start of cycle is PWM3). The PWM4 which is the last PWM in the cascaded sequence broadcast the Update bit to all PWMs (PWM1/2/3 data update is dependent on the Update bit of PWM4).</p>
<center> <img src="images/pwm-configuration.jpg" alt="PWM config MCC" width="1200" class="inline"/> <br  />
 PWM configuration in MCC Melody. </center> <p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<p><span id="adc-setup"><a class="anchor" id="adc-setup"></a> </span></p>
<h2><a class="anchor" id="autotoc_md18"></a>
ADC Setup</h2>
<p>add content here</p>
<hr  />
<p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<hr  />
<p><span id="compensator-settings"><a class="anchor" id="compensator-settings"></a> </span></p>
<h2><a class="anchor" id="autotoc_md19"></a>
Compensator Settings</h2>
<p>mention DCDT configuration relevant files for dcdt</p>
<p>[<a class="el" href="index.html#start-doc">back to top</a>]</p>
<p>&copy; 2024, Microchip Technology Inc.</p>
<hr  />
<h3>Footnotes</h3>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.20-->
<!-- start footer part -->
<div id="nav-path" class="navpath" style="padding-bottom: 12px; vertical-align: bottom;"><!-- id is needed for treeview function! -->
  <ul>
    <p class="footer" style="text-align: center; font-size: 90%;">
      Â© Copyright 1998-2022 Microchip Technology Inc. All rights reserved.
    </p>
    </ul>
</div>
</body>
</html>
